# Usage of Extended Falcor

## Features

## Fixes

### Support hit group type `D3D12_HIT_GROUP_TYPE_PROCEDURAL_PRIMITIVE` [#2798308](https://github.com/VicentChen/Falcor/commit/2798308aafcd5ffdaa5bcc0fa4f4f0439fcc8299)

```c++
RtProgram::Desc desc;
desc.addHitGroup(0, "closestHit", "anyHit", "intersection").addMiss(0, "miss");
desc.setHitGroupType(D3D12_HIT_GROUP_TYPE_PROCEDURAL_PRIMITIVE);
// or:
RtProgram::Desc desc;
desc.addHitGroup(0, "closestHit", "anyHit", "intersection", D3D12_HIT_GROUP_TYPE_PROCEDURAL_PRIMITIVE).addMiss(0, "miss");
```

### Support procedural scene [#4b2437a](https://github.com/VicentChen/Falcor/commit/4b2437aa9325a2f50d3abfd1f812adf8dfa56b8a)

#### Construction
 - `ProcedrualScene` needs one `ProceduralScene::Tlas` to configure the acceleration structure. TLAS is composed of one or more `ProceduralScene::Blas`.
 - A BLAS in TLAS can have multiple instances. User-defined indices of instances can be accessed by `InstanceID()` in shaders.
 - BLAS is composed of one or more geometries.
 - Geometry is composed of one or more primitives. Indices of geometries generated by DXR can be accessed by `GeometryIndex()` in shaders.
 - In procedural scene, a primitive is an AABB. Indices of primitives generated by DXR can be accessed by `PrimitiveIndex()` in shaders.

#### Usage: similar to the original `Scene`.

```c++
// Tlas construction
BoundingBox AABB { float3(0, 0, 0), float3(1, 1, 1) };

ProceduralScene::Tlas Tlas;

ProceduralScene::Blas Blas;
Blas.mGeometries.emplace_back(ProceduralScene::Geometry{ "AABB", {AABB} });

ProceduralScene::Instance Instance;
Instance.mID = i;
Instance.mMask = 0xFF;
Instance.mFlags = D3D12_RAYTRACING_INSTANCE_FLAG_NONE;
Instance.mTransformMtx = glm::scale(glm::translate(glm::mat4(), vLSPs[i].Center), float3(vLSPs[i].Radius * 2));
Blas.mInstances.emplace_back(std::move(Instance));

Tlas.emplace_back(Blas);

// construct
ProceduralScene::SharedPtr pLSPScene = ProceduralScene::create();
pLSPScene->setScene(Tlas);

// ray trace
pLSPScene->raytrace(/* ... */);
```

### Support model material in `fscene` [#a0c932f](https://github.com/VicentChen/Falcor/commit/a0c932f5f03270f1a052d6073a5260cabac9d084)

We use parameters in `.mtl` files to specify materials.

Keywords inside `materials`:
 - `target_mesh`: this material will apply to meshes with same name in the model. If this term's value is empty or not explicitly specified, this material will apply to whole model.
 - `ambient`: `Ka` in `.mtl` files.
 - `diffuse`: `Kd` in `.mtl` files.
 - `specular`: `Ks` in `.mtl` files.
 - `emissive`: `Ke` in `.mtl` files.
 - `ns_ni_d`: `Ns`, `Ni` and `d` in `.mtl` files.

Example:
```json
{
	"file": "Dragon.obj",
	"name": "Dragon",
	"instances": [ {"name": "Dragon" } ],
	"materials": [
		{
			"diffuse": [0.63,0.065,0.05],
			"specular": [0.9,0.9,0.9],
			"ns_ni_d": [50,1,1]
		}
	]
}
```
Some behaviors:
 - If two materials have same `target_mesh`, the latter one will overwrite the formers.
